<!-- templates/index.html -->

<!doctype html>
<html>
<head>
    <title>Class Scheduler</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Existing styles */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1, h2, h3 {
            color: #333;
        }

        /* Schedule Table Styles */
        .schedule-table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 30px;
        }

        .schedule-table th, .schedule-table td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: center;
            width: 12.5%; /* Adjusted for 8 columns including Time */
            height: 60px; /* Increased height */
            font-size: 12px;
            overflow: hidden;
            white-space: normal; /* Allow text to wrap */
            word-wrap: break-word; /* Break long words */
        }

        .schedule-table th {
            background-color: #f2f2f2;
        }

        /* Class selection styles */
        .class-selection {
            display: flex;
            flex-wrap: wrap;
            max-height: 400px; /* Set a max height with scroll */
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
        }

        .class-selection div {
            width: 200px; /* Adjust width as needed */
            margin-right: 15px;
            margin-bottom: 10px;
        }

        /* Search bar styles */
        #searchBar {
            width: 100%;
            max-width: 400px;
            padding: 8px 12px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        /* Personal schedule block styles */
        #personalSchedule {
            margin-bottom: 20px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 4px;
        }

        .personal-block {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .personal-block .days-container {
            margin-bottom: 10px;
        }

        .personal-block label {
            margin-right: 10px;
            display: inline-block;
            margin-bottom: 5px;
        }

        .remove-block {
            margin-top: 10px;
            background-color: #e74c3c;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }

        .remove-block:hover {
            background-color: #c0392b;
        }

        /* Conflict class label */
        .conflict {
            color: red;
            font-weight: bold;
        }

        /* Scrollbar styling for class selection */
        .class-selection::-webkit-scrollbar {
            width: 8px;
        }

        .class-selection::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }

        .class-selection::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }

        .class-selection::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
    </style>
    <script>
        $(document).ready(function() {
            function updateSchedules() {
                let selectedClassIds = $('input[name="classCheckbox"]:checked').map(function() {
                    return $(this).val();
                }).get();

                console.log('Selected Class IDs:', selectedClassIds);

                // Get personal schedule blocks
                let personalSchedule = [];
                $('.personal-block').each(function() {
                    // Collect selected days from checkboxes
                    let selectedDays = [];
                    $(this).find('input[name="daysCheckbox"]:checked').each(function() {
                        selectedDays.push($(this).val());
                    });

                    let startTime = $(this).find('.start-time').val();
                    let endTime = $(this).find('.end-time').val();

                    if (startTime && endTime && (!isValidTime(startTime) || !isValidTime(endTime))) {
                        alert('Please enter valid start and end times.');
                        return false;
                    }

                    if (selectedDays.length > 0 && startTime && endTime) {
                        personalSchedule.push({
                            'days': selectedDays.join(''),
                            'start_time': startTime.replace(':', ''),
                            'end_time': endTime.replace(':', '')
                        });
                    }
                });

                console.log('Personal Schedule:', personalSchedule);

                if (selectedClassIds.length > 0) {
                    $.ajax({
                        url: "/generate_schedules",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({
                            'class_ids': selectedClassIds,
                            'personal_schedule': personalSchedule
                        }),
                        success: function(response) {
                            console.log('AJAX Success. Response:', response);
                            $('#schedules').empty();

                            if (response.length > 0) {
                                // Create a set to hold unique class names
                                let classNamesSet = new Set();

                                // Collect all class names from the schedules
                                response.forEach(function(schedule) {
                                    schedule.sections.forEach(function(section) {
                                        classNamesSet.add(section.class_name);
                                    });
                                });

                                // Convert the set to an array for indexing
                                const classNamesArray = Array.from(classNamesSet);

                                // Generate pastel colors
                                const pastelColors = generatePastelColors(classNamesArray.length + 1); // +1 for 'Personal Time'

                                // Create a color mapping for class names
                                let colorMapping = {};

                                classNamesArray.forEach(function(className, index) {
                                    colorMapping[className] = pastelColors[index];
                                });

                                // Assign the last color to 'Personal Time'
                                colorMapping['Personal Time'] = pastelColors[classNamesArray.length];

                                // Render each schedule
                                response.forEach(function(schedule, index) {
                                    let scheduleHtml = `<h3>Schedule Option ${index + 1}</h3>`;

                                    // Render the schedule table with color mapping
                                    scheduleHtml += renderScheduleTable(schedule.matrix, colorMapping);

                                    // Display the class sections
                                    scheduleHtml += `<table>
                                        <thead>
                                            <tr>
                                                <th>Class Name</th>
                                                <th>Time</th>
                                                <th>Days</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                                    schedule.sections.forEach(function(section) {
                                        scheduleHtml += `<tr>
                                            <td>${section.class_name}</td>
                                            <td>${formatTime(section.start_time)} - ${formatTime(section.end_time)}</td>
                                            <td>${section.days}</td>
                                        </tr>`;
                                    });
                                    scheduleHtml += `</tbody></table>`;
                                    $('#schedules').append(scheduleHtml);
                                });
                            } else {
                                $('#schedules').append('<p>No valid schedules found.</p>');
                            }
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            console.log('AJAX Error:', textStatus, errorThrown);
                        }
                    });
                } else {
                    $('#schedules').empty();
                }
            }

            // Function to generate pastel colors
            function generatePastelColors(numColors) {
                const colors = [];
                const saturation = 70; // Adjust for desired pastel intensity
                const lightness = 85;  // Adjust for desired brightness
                const hueStep = 360 / numColors;

                for (let i = 0; i < numColors; i++) {
                    const hue = (i * hueStep) % 360;
                    colors.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
                }
                return colors;
            }

            // Function to render the schedule table
            function renderScheduleTable(matrix, colorMapping) {
                // Define days and time slots
                const days = ['M', 'Tu', 'W', 'Th', 'F', 'Sa', 'Su'];
                const startTime = 8 * 60; // 8:00 AM in minutes
                const endTime = 22 * 60;  // 10:00 PM in minutes
                const timeIncrement = 30; // 30-minute increments

                // Generate time labels
                let timeLabels = [];
                for (let minutes = startTime; minutes < endTime; minutes += timeIncrement) {
                    let hours = Math.floor(minutes / 60);
                    let mins = minutes % 60;
                    let timeLabel = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
                    timeLabels.push(timeLabel);
                }

                // Build the table
                let tableHtml = `<table class="schedule-table"><thead><tr><th>Time</th>`;
                days.forEach(day => {
                    tableHtml += `<th>${day}</th>`;
                });
                tableHtml += `</tr></thead><tbody>`;

                // Calculate total time slots based on the increment
                const totalTimeSlots = (endTime - startTime) / timeIncrement;

                // Build table rows
                for (let i = 0; i < totalTimeSlots; i++) {
                    tableHtml += `<tr><td>${timeLabels[i]}</td>`;
                    for (let j = 0; j < days.length; j++) {
                        let cellContent = '';
                        let cellStyle = '';
                        let matrixIndex = i * (30 / 5); // Adjust index for 30-minute increments
                        let classInfos = [];
                        // Loop through the corresponding 5-minute slots
                        for (let k = 0; k < (30 / 5); k++) {
                            let idx = Math.floor(matrixIndex + k);
                            if (matrix[idx] && matrix[idx][j]) {
                                let classInfo = matrix[idx][j];
                                if (!classInfos.some(ci => ci.class_name === classInfo.class_name)) {
                                    classInfos.push(classInfo);
                                }
                            }
                        }
                        if (classInfos.length > 0) {
                            cellContent = classInfos.map(ci => {
                                return `${ci.class_name}<br>${formatTime(ci.start_time)} - ${formatTime(ci.end_time)}`;
                            }).join('<hr>');
                            // Get the color for the class
                            let classColor = colorMapping[classInfos[0].class_name] || '#8ac6d1'; // Default color if not found
                            cellStyle = `background-color: ${classColor}; color: #000;`;
                        }
                        tableHtml += `<td style="${cellStyle}">${cellContent}</td>`;
                    }
                    tableHtml += `</tr>`;
                }

                tableHtml += `</tbody></table>`;
                return tableHtml;
            }

            // Validate time format (HH:MM)
            function isValidTime(timeStr) {
                return /^([0-1]\d|2[0-3]):([0-5]\d)$/.test(timeStr);
            }

            // Format time from "HHMM" to "HH:MM"
            function formatTime(timeStr) {
                let timeStrPadded = timeStr.toString().padStart(4, '0');
                let hours = timeStrPadded.substr(0, 2);
                let minutes = timeStrPadded.substr(2, 2);
                return `${hours}:${minutes}`;
            }

            // Function to filter classes based on search input
            function filterClasses(query) {
                query = query.toLowerCase();
                $('.class-selection div').each(function() {
                    let label = $(this).find('label').text().toLowerCase();
                    if (label.includes(query)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }

            // Event listeners
            $('input[name="classCheckbox"]').change(updateSchedules);

            // Add personal schedule block
            $('#addPersonalBlock').click(function() {
                $('#personalSchedule').append(`
                    <div class="personal-block">
                        <div class="days-container">
                            <label>Days:</label>
                            <label><input type="checkbox" name="daysCheckbox" value="M"> M</label>
                            <label><input type="checkbox" name="daysCheckbox" value="Tu"> Tu</label>
                            <label><input type="checkbox" name="daysCheckbox" value="W"> W</label>
                            <label><input type="checkbox" name="daysCheckbox" value="Th"> Th</label>
                            <label><input type="checkbox" name="daysCheckbox" value="F"> F</label>
                            <label><input type="checkbox" name="daysCheckbox" value="Sa"> Sa</label>
                            <label><input type="checkbox" name="daysCheckbox" value="Su"> Su</label>
                        </div>
                        <div class="time-container">
                            <label>Start Time:
                                <input type="time" class="start-time" required>
                            </label>
                            <label>End Time:
                                <input type="time" class="end-time" required>
                            </label>
                        </div>
                        <button type="button" class="remove-block">Remove</button>
                    </div>
                `);
            });

            // Remove personal schedule block
            $(document).on('click', '.remove-block', function() {
                $(this).parent('.personal-block').remove();
                updateSchedules();
            });

            // Update schedules when personal schedule changes
            $(document).on('change', '.personal-block input', updateSchedules);

            // Add event listener for the search bar
            $('#searchBar').on('input', function() {
                let query = $(this).val();
                filterClasses(query);
            });
        });
    </script>
</head>
<body>
    <h1>Select Available Classes</h1>

    <!-- Search Bar -->
    <input type="text" id="searchBar" placeholder="Search for classes..." />

    <!-- Class Selection List -->
    <div class="class-selection">
        {% for class in classes %}
            <div>
                <input type="checkbox" name="classCheckbox" id="class{{ class['id'] }}" value="{{ class['id'] }}">
                <label for="class{{ class['id'] }}" class="class-label">{{ class['class_id'] }}</label>
            </div>
        {% endfor %}
    </div>

    <h2>Personal Schedule Blocks</h2>
    <div id="personalSchedule">
        <!-- Personal schedule blocks will be added here -->
    </div>
    <button type="button" id="addPersonalBlock">Add Personal Schedule Block</button>

    <div id="schedules">
        <!-- Generated schedules will be displayed here -->
    </div>
</body>
</html>
